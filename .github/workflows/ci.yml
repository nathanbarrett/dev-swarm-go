name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Show coverage
        run: go tool cover -func=coverage.out

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Run go vet
        run: go vet ./...

      - name: Check formatting
        run: |
          if [ -n "$(gofmt -s -l .)" ]; then
            echo "Go code is not formatted:"
            gofmt -s -d .
            exit 1
          fi

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build binary
        run: go build -o bin/dev-swarm-go ./cmd/dev-swarm-go

      - name: Verify binary runs
        run: ./bin/dev-swarm-go version

  version-check:
    name: Version Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          path: pr

      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          path: main

      - name: Check npm version incremented
        run: |
          PR_VERSION=$(cat pr/npm/package.json | jq -r '.version')
          MAIN_VERSION=$(cat main/npm/package.json | jq -r '.version')

          echo "PR version: $PR_VERSION"
          echo "Main version: $MAIN_VERSION"

          # Compare versions using sort -V
          if [ "$PR_VERSION" = "$MAIN_VERSION" ]; then
            echo "::error::npm version ($PR_VERSION) has not been incremented from main ($MAIN_VERSION)"
            echo ""
            echo "Please update the version in npm/package.json"
            exit 1
          fi

          # Check if PR version is greater
          HIGHER=$(echo -e "$PR_VERSION\n$MAIN_VERSION" | sort -V | tail -n1)
          if [ "$HIGHER" != "$PR_VERSION" ]; then
            echo "::error::PR version ($PR_VERSION) is not greater than main ($MAIN_VERSION)"
            exit 1
          fi

          echo "Version check passed: $MAIN_VERSION -> $PR_VERSION"
